<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1.0" />
  <title>판교고등학교</title>

  <!-- p5.js & ml5.js -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/1.9.0/p5.min.js"></script>
  <script src="https://unpkg.com/ml5@latest/dist/ml5.min.js"></script>

  <style>
    :root {
      --sky1:#87CEEB; --sky2:#E0F7FA; --accent:#ff6d00; --panel:#ffffff;
      --text:#1a1a1a; --muted:#9e9e9e; --good:#43a047; --left:#4caf50; --right:#2196f3; --fist:#ff5722;
    }
    *{box-sizing:border-box}
    body{
      margin:0; font-family: "Malgun Gothic", system-ui, -apple-system, Segoe UI, Roboto, "Noto Sans KR", sans-serif;
      background:linear-gradient(to bottom,var(--sky1),var(--sky2));
      color:var(--text);
    }
    header{
      padding:18px 20px 6px; text-align:center;
    }
    h1{margin:0;font-size:22px}
    #wrapper{max-width:920px; margin:0 auto; padding:8px 12px 24px}
    #inst{
      margin:10px auto 16px; padding:12px 14px;
      background:#e8f5e9; border:2px solid var(--good); border-radius:12px; text-align:center;
      font-size:14px;
    }
    #gameWrap{
      position:relative; margin:0 auto; width:min(92vw,820px);
      aspect-ratio: 3 / 2;  /* 600x400 비율 유지 */
    }
    #overlay{
      position:absolute; inset:0; display:flex; align-items:center; justify-content:center; pointer-events:none;
    }
    #hud{
      position:absolute; right:10px; top:10px; width:180px; z-index:10;
      background:rgba(255,255,255,.96); border-radius:12px; box-shadow:0 4px 16px rgba(0,0,0,.15);
      padding:10px 10px 12px; font-size:13px;
    }
    #hud h3{margin:0 0 8px; font-size:14px}
    .row{margin:6px 0}
    .name{display:flex; justify-content:space-between; align-items:center; font-weight:600}
    .bar{height:12px; background:#ececec; border-radius:6px; overflow:hidden; margin-top:3px}
    .fill{height:100%}
    #cam{
      position:absolute; right:10px; top:176px; width:180px; z-index:10;
      border:5px solid var(--accent); border-radius:12px; overflow:hidden; background:#000; box-shadow:0 4px 16px rgba(0,0,0,.15);
    }
    #status{
      text-align:center; margin:12px auto 0; font-size:16px;
    }
    .gest{font-weight:800; color:#d50000}
    footer{margin:18px 0 8px; text-align:center; font-size:12px; color:#444}
    @media (max-width:580px){
      #hud,#cam{right:6px; top:6px; width:156px}
      #cam{top:160px}
    }
  </style>
</head>
<body>
  <header><h1>판교고등학교 – AI 제스처 게임</h1></header>

  <div id="wrapper">
    <div id="inst">
      왼쪽 → 캐릭터 왼쪽 이동 · 오른쪽 → 캐릭터 오른쪽 이동 · 주먹 → 점프 · none(없음) → 정지<br/>
      팁: 조명 밝게, 배경 단순하게, 손을 화면 중앙에!
    </div>

    <div id="gameWrap">
      <!-- p5 캔버스가 여기 들어감 -->
      <div id="hud">
        <h3>AI 확신도</h3>
        <div id="prob"></div>
      </div>
      <div id="cam"><!-- 웹캠 프리뷰를 여기에 그림 --></div>
      <div id="overlay"></div>
    </div>

    <div id="status">현재 판단: <span class="gest" id="gest">모델/웹캠 준비 중…</span></div>
    <footer>GitHub Pages(HTTPS)에서 실행해야 카메라 권한이 열립니다.</footer>
  </div>

  <script>
    // === 설정 ===
    const MODEL_URL = 'https://teachablemachine.withgoogle.com/models/EvIZbroaE/';
    const USE_SMOOTHING = true;       // 예측 흔들림 완화 (EMA)
    const SMOOTHING_ALPHA = 0.35;     // 0~1 (클수록 최신값 가중)
    const DECISION_HOLD_MS = 180;     // 의사결정 유지시간(ms)로 튐 방지
    const MIN_DECISION_CONF = 0.55;   // 이 값보다 낮으면 none 처리

    // === 전역 ===
    let classifier, video;
    let readyVideo = false, readyModel = false;
    let label = 'None';

    // 예측 누적(EMA)
    const labels = ['Fist','Left','Right','None'];  // 예상 클래스들
    const conf = { Fist:0, Left:0, Right:0, None:0 };
    let lastDecision = { label:'None', t:0 };

    // 게임 상태
    let x=275, y=300, vx=0, vy=0;
    const W=600, H=400, G=0.8, FRICTION=0.85, SPEED=1.2, AIR=0.92, JUMP_V=-14;
    let grounded = true;

    // p5: 미리 로드 (ml5 분류기)
    function preload(){
      classifier = ml5.imageClassifier(MODEL_URL + 'model.json', () => {
        readyModel = true;
        console.log('모델 로드 완료');
        if (readyVideo) startClassify();
      });
    }

    // p5: 셋업
    function setup(){
      // 반응형 캔버스 크기 계산
      const wrap = document.getElementById('gameWrap');
      const br = wrap.getBoundingClientRect();
      const cw = Math.min(br.width, 820);
      const ch = cw * (2/3); // 3:2 비율 → 400/600=0.666...

      const c = createCanvas(cw, ch);
      c.parent('gameWrap');

      // 비율에 맞춰 물리 공간도 스케일 유지
      // 내부 로직은 600x400 기준으로, 그리기 시 scale()로 맞춤
      pixelDensity(1);

      video = createCapture({ video: { facingMode: "user", width: 320, height: 240 }, audio:false }, () => {
        console.log('웹캠 준비 완료');
      });
      video.size(160, 120);
      video.hide();
      readyVideo = true;

      if (readyModel) startClassify();

      // 확률 패널 초기 렌더
      renderProb();

      // 리사이즈 대응
      window.addEventListener('resize', () => {
        const br2 = wrap.getBoundingClientRect();
        const cw2 = Math.min(br2.width, 820);
        const ch2 = cw2*(2/3);
        resizeCanvas(cw2, ch2);
      });

      // 5초 후 권한 안내
      setTimeout(() => {
        if (!video || video.width === 0)
          alert('웹캠이 안 켜졌어요!\n1) 카메라 권한 허용\n2) 페이지 새로고침\n3) HTTPS(깃허브 페이지)에서 실행');
      }, 5000);
    }

    // 분류 루프 시작
    function startClassify(){
      // 재귀 분류 루프 (classifyStart 대신 안전한 표준 루프)
      const loop = () => {
        classifier.classify(video, gotResults);
      };
      loop();
    }

    // 결과 수신
    function gotResults(err, results){
      if (err) { console.error(err); requestAnimationFrame(()=>classifier.classify(video, gotResults)); return; }
      if (!results || results.length===0) { requestAnimationFrame(()=>classifier.classify(video, gotResults)); return; }

      // 수신값을 라벨/확률에 반영
      // 결과 라벨은 대소문자·스페이스가 모델마다 다를 수 있어 정규화
      const current = {};
      labels.forEach(k => current[k]=0);

      results.forEach(r=>{
        const norm = normalizeLabel(r.label);
        if (current.hasOwnProperty(norm)) current[norm] = Math.max(current[norm], r.confidence || 0);
      });

      // EMA로 스무딩
      labels.forEach(k=>{
        conf[k] = USE_SMOOTHING
          ? (SMOOTHING_ALPHA*current[k] + (1-SMOOTHING_ALPHA)*conf[k])
          : current[k];
      });

      // 의사결정: 최댓값이 임계값 미만이면 None
      let topL='None', topV=conf['None'];
      labels.forEach(k=>{ if (conf[k]>topV){ topV=conf[k]; topL=k; }});
      const now = performance.now();

      // 튐 방지: 일정 시간 동안만 바꾸기 허용
      if (topV >= MIN_DECISION_CONF) {
        if (now - lastDecision.t > DECISION_HOLD_MS || lastDecision.label===topL) {
          label = topL;
          lastDecision = { label:topL, t:now };
        }
      } else {
        label = 'None';
        lastDecision = { label:'None', t:now };
      }

      // HUD 업데이트
      renderProb();
      const gestKor = {Left:'왼쪽', Right:'오른쪽', Fist:'주먹', None:'없음'};
      document.getElementById('gest').textContent = (gestKor[label] || label);

      // 다음 분류 예약
      requestAnimationFrame(()=>classifier.classify(video, gotResults));
    }

    // p5: 프레임 루프
    function draw(){
      // 내부 해상도(600x400)로 그리고, 캔버스 크기에 맞게 스케일
      const sx = width/600, sy = height/400;
      push(); scale(sx, sy);

      // 하늘
      background(135,206,235);

      // 땅
      noStroke();
      fill(139,69,19); rect(0,350,600,50);
      fill(34,139,34);
      for(let i=0;i<600;i+=30) rect(i,345,20,10);

      // 웹캠 프리뷰 우상단 (DOM 박스 위치에 맞춰 동일 자리)
      image(video, 600-170, 10, 160, 120);
      noFill(); stroke(255, 109, 0); strokeWeight(5); rect(600-170, 10, 160, 120, 12);

      // 물리 업데이트
      // 입력 해석: Left/Right/Fist/None
      if (label==='Left')  vx -= SPEED;
      if (label==='Right') vx += SPEED;
      if (label==='Fist' && grounded){
        vy = JUMP_V; grounded = false;
      }

      // 중력/마찰
      vy += G;
      y += vy;
      x += vx;

      // 지면 충돌
      if (y >= 300){ y=300; vy=0; grounded=true; }

      // 마찰 (지면/공중)
      vx *= grounded ? FRICTION : AIR;

      // 벽 처리
      if (x < 0) { x=0; vx=0; }
      if (x > 550) { x=550; vx=0; }

      // 캐릭터(귀여운 아이콘)
      drawChick(x,y);

      pop(); // scale 되돌림

      // 카메라 DOM 상자 안에 p5 비디오를 복제로 넣고 싶다면 별도 처리 가능
      // 여기서는 p5 캔버스에 그려주는 것으로 충분
    }

    function drawChick(cx, cy){
      push();
      // 몸통
      noStroke(); fill(255, 235, 59); rect(cx, cy, 50, 50, 14);
      // 눈
      fill(255); ellipse(cx+15, cy+18, 15, 15); ellipse(cx+35, cy+18, 15, 15);
      fill(0); ellipse(cx+15, cy+18, 7, 7); ellipse(cx+35, cy+18, 7, 7);
      // 부리
      fill(255, 109, 0); triangle(cx+22, cy+26, cx+28, cy+26, cx+25, cy+33);
      // 볼
      fill(255, 138, 128); ellipse(cx+10, cy+28, 7,7); ellipse(cx+40, cy+28, 7,7);
      // 그림자
      fill(0,0,0,40); ellipse(cx+25, cy+50, 36, 8);
      pop();
    }

    // 확률 패널 렌더
    function renderProb(){
      const container = document.getElementById('prob');
      const kor = { Fist:'주먹', Left:'왼쪽', Right:'오른쪽', None:'없음' };
      const col = { Fist:'var(--fist)', Left:'var(--left)', Right:'var(--right)', None:'var(--muted)' };

      // 최대값 강조
      let maxK='None', maxV=conf['None'];
      Object.keys(conf).forEach(k=>{ if(conf[k]>maxV){maxK=k;maxV=conf[k];} });

      container.innerHTML = Object.keys(conf).map(k=>{
        const pct = (conf[k]*100).toFixed(1);
        const w = Math.round(conf[k]*160);
        const bold = (k===maxK) ? 700 : 500;
        const color = (k===maxK) ? '#d50000' : '#333';
        return `
          <div class="row">
            <div class="name" style="color:${color};font-weight:${bold}">
              <span>${kor[k]} </span><span>${pct}%</span>
            </div>
            <div class="bar"><div class="fill" style="width:${w}px;background:${col[k]}"></div></div>
          </div>
        `;
      }).join('');
    }

    // 라벨 정규화: 모델의 클래스 표기가 제각각일 수 있어 안전 처리
    function normalizeLabel(raw){
      if (!raw) return 'None';
      const s = String(raw).toLowerCase().trim();
      if (s.includes('left') || s.includes('왼')) return 'Left';
      if (s.includes('right')|| s.includes('오른')) return 'Right';
      if (s.includes('fist') || s.includes('주먹')) return 'Fist';
      if (s.includes('none') || s.includes('배경') || s.includes('없')) return 'None';
      // 알 수 없는 라벨은 가장 높은 항목 외엔 none으로 수렴
      return s.charAt(0).toUpperCase()+s.slice(1);
    }
  </script>
</body>
</html>
