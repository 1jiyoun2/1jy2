<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>AI 손 제스처 – 실시간 분류</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/1.9.0/p5.min.js"></script>
  <script src="https://unpkg.com/ml5@latest/dist/ml5.min.js"></script>
  <style>
    body{margin:0;padding:20px;font-family:'Malgun Gothic',sans-serif;
         background:linear-gradient(to bottom,#87CEEB,#E0F7FA);text-align:center}
    #game{position:relative;margin:30px auto;width:600px;height:400px}
    #webcam{position:absolute;top:10px;right:10px;z-index:10;
            border:5px solid #ff5722;border-radius:12px;box-shadow:0 4px 15px rgba(0,0,0,.3)}
    #prob{position:absolute;top:140px;right:10px;width:160px;z-index:10;
          background:rgba(255,255,255,.95);padding:10px;border-radius:12px;
          font-size:13px;box-shadow:0 2px 10px rgba(0,0,0,.2)}
    .bar{height:16px;margin:4px 0;border-radius:4px;background:#e0e0e0}
    .fill{height:100%;border-radius:4px}
    #inst{margin:15px;padding:18px;background:#e8f5e9;border-radius:12px;
          border:2px solid #4caf50;display:inline-block}
    h1{color:#1b5e20}
    .gest{font-weight:bold;color:#d50000;font-size:1.4em}
  </style>
</head>
<body>
  <h1>AI 손 제스처 – 실시간 콘솔 & 확률</h1>
  <div id="inst">
    <p><strong>왼쪽 → 왼쪽 | 오른쪽 → 오른쪽 | 주먹 → 점프!</strong></p>
  </div>

  <div id="game"></div>
  <p>현재 판단: <span class="gest" id="gest">대기 중...</span></p>

  <script>
    const MODEL_URL = 'https://teachablemachine.withgoogle.com/models/6uKiaMXZR/';
    let classifier, video, probDiv;
    let label = '대기 중...';
    let conf = { Fist:0, Right:0, Left:0, None:0 };
    let x = 275, y = 300, jumping = false;

    function preload() {
      classifier = ml5.imageClassifier(MODEL_URL + 'model.json', modelLoaded);
    }

    let modelReady = false;

    function modelLoaded() {
      console.log('모델 로드 완료!');
      modelReady = true;
      // video가 준비되면 분류 시작
      if (video && video.loadedmetadata) {
        startClassifying();
      }
    }

    function setup() {
      let c = createCanvas(600, 400);
      c.parent('game');

      video = createCapture(VIDEO);
      video.size(160, 120);
      video.hide();

      // 비디오 준비 완료 이벤트
      video.elt.addEventListener('loadedmetadata', () => {
        console.log('웹캠 준비 완료!');
        if (modelReady) {
          startClassifying();
        }
      });

      // 확률 바 DOM 한 번만 생성
      probDiv = createDiv('');
      probDiv.id('prob');
      probDiv.parent('game');
    }

    function startClassifying() {
      console.log('분류 시작...');
      classifier.classifyStart(video, gotResults);
    }

    function draw() {
      background(135, 206, 235);
      drawFloor();

      // 웹캠
      image(video, width - 170, 10, 160, 120);
      noFill(); stroke(255, 87, 34); strokeWeight(5);
      rect(width - 170, 10, 160, 120, 12);

      // 확률 바 업데이트
      updateProb();

      // 캐릭터
      drawChar();

      // 제스처 반응
      if (label === 'Left') x -= 7;
      if (label === 'Right') x += 7;
      if (label === 'Fist' && !jumping) jump();

      x = constrain(x, 0, width - 50);
      select('#gest').html(getName(label));
    }

    // 실시간 확률 바
    function updateProb() {
      const order = ['Fist', 'Right', 'Left', 'None'];
      const kor = { Fist: '주먹', Right: '오른쪽', Left: '왼쪽', None: '없음' };
      const col = { Fist: '#ff5722', Right: '#2196f3', Left: '#4caf50', None: '#9e9e9e' };

      let max = 0, maxL = '';
      order.forEach(k => { if (conf[k] > max) { max = conf[k]; maxL = k; } });

      let html = '<b>AI 확신도</b><br>';
      order.forEach(k => {
        let w = conf[k] * 150;
        let bold = k === maxL ? 'bold' : 'normal';
        let c = k === maxL ? '#d50000' : '#333';
        html += `
          <div style="margin:5px 0;text-align:left">
            <div style="color:${c};font-weight:${bold}">${kor[k]}: ${(conf[k]*100).toFixed(1)}%</div>
            <div class="bar"><div class="fill" style="width:${w}px;background:${col[k]}"></div></div>
          </div>`;
      });
      probDiv.html(html);
    }

    function drawFloor() {
      fill(139, 69, 19); rect(0, 350, width, 50);
      fill(34, 139, 34);
      for (let i = 0; i < width; i += 30) rect(i, 345, 20, 10);
    }

    function drawChar() {
      fill(76, 175, 80); rect(x, y, 50, 50, 12);
      fill(255); ellipse(x + 15, y + 18, 16); ellipse(x + 35, y + 18, 16);
      fill(0); ellipse(x + 15, y + 18, 8); ellipse(x + 35, y + 18, 8);
    }

    function jump() {
      jumping = true; y = 200;
      setTimeout(() => { y = 300; jumping = false; }, 700);
    }

    // 핵심: 연속 분류 콜백 (자동으로 계속 호출됨)
    function gotResults(results) {
      if (!results || results.length === 0) {
        console.error('결과 없음');
        return;
      }

      // 1. 콘솔에 계속 찍기
      console.log('실시간 결과:', results);

      // 2. 라벨 & 확률 업데이트
      label = results[0].label;
      results.forEach(r => {
        conf[r.label] = r.confidence;
      });
    }

    function getName(l) {
      const m = { Left: '왼쪽', Right: '오른쪽', Fist: '주먹!', None: '없음' };
      return m[l] || l;
    }

    // 웹캠 권한 확인
    setTimeout(() => {
      if (!video || video.width === 0) {
        alert('웹캠이 안 켜졌어요!\n1. 카메라 권한 허용\n2. 페이지를 새로고침');
      }
    }, 5000);
  </script>
</body>
</html>
